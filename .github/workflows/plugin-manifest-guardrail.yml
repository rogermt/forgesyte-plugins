name: Plugin Manifest Guardrail

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  validate-manifests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install server dependencies
        run: |
          cd server
          pip install -e .
          pip install uvicorn

      - name: Start ForgeSyte server
        run: |
          cd server
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch plugin list
        id: plugins
        run: |
          PLUGINS=$(curl -s http://localhost:8000/v1/plugins | jq -r '.plugins[].name')
          echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

      - name: Validate each plugin manifest
        run: |
          FAILED=0
          for plugin in ${{ steps.plugins.outputs.plugins }}; do
            echo "Checking manifest for plugin: $plugin"

            STATUS=$(curl -s -o /tmp/manifest.json -w "%{http_code}" \
              http://localhost:8000/v1/plugins/$plugin/manifest)

            if [ "$STATUS" != "200" ]; then
              echo "::error::Manifest missing or invalid for plugin '$plugin' (HTTP $STATUS)"
              FAILED=1
              continue
            fi

            # Validate JSON structure
            if ! jq -e '.id and .name and .version and .tools' /tmp/manifest.json > /dev/null; then
              echo "::error::Manifest for plugin '$plugin' missing required fields"
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            echo "::error::One or more plugin manifests failed validation"
            exit 1
          fi

          echo "All plugin manifests validated successfully"
